#!/bin/bash

# Set paths
SloKJVepubPath=/home/pc/Dokumenti/epub
SloKJV_Module_Path=/usr/share/sword/modules/texts/ztext/slokjv
SloKJV_Mods_Path=/usr/share/sword/mods.d
SloKJV_Github=/home/pc/Dokumenti/GitHub/SloKJV

# SloKJV module from Github
# wget https://github.com/msavli/SloKJV/raw/master/SloKJV_sword.xml -O $SloKJVepubPath/SloKJV_sword.xml
#   To sem dobil iz   git clone https://github.com/pierre-amadio/SwordSandBox

echo
echo    Vlecem iz Githuba....  zakomentirano
echo 
cd $SloKJV_Github
git pull


# Create folders
mkdir  $SloKJVepubPath                                                         >/dev/null 2>&1
cd $SloKJVepubPath
rm -rf html
mkdir html                                                                      >/dev/null 2>&1
mkdir $SloKJV_Module_Path                                                       >/dev/null 2>&1
mkdir /usr/share/sword                                                          >/dev/null 2>&1
mkdir /usr/share/sword/modules                                                  >/dev/null 2>&1
mkdir /usr/share/sword/modules/texts                                            >/dev/null 2>&1
mkdir /usr/share/sword/modules/texts/ztext                                      >/dev/null 2>&1
mkdir /usr/share/sword/modules/texts/ztext/slokjv                               >/dev/null 2>&1

# Kopira predloge in kaj je se za narediti
cp templates/Foreword.html          html/02-Foreword.html
cp templates/cover.html             html/00_preimenuj_me_v_cover.xhtml
cp templates/content_opf.xhtml      html/00_Vsebino_metadata_daj_v_content.opf_in_popravi_datum_.xhtml
echo "<html><body></body></html>" > html/00_pobrisi_Section001.xhtml
echo "<html><body></body></html>" > html/00_dodaj_font.xhtml
echo "<html><body></body></html>" > html/00_vsebino_toc.ncx_prekopiraj_v_toc.ncx_fajl.xhtml


echo
echo    Kreiram SloKJV modul...
echo
echo         Prekopiram se conf datoteko
cp $SloKJV_Github/slokjv.conf $SloKJV_Mods_Path/slokjv.conf

echo
osis2mod $SloKJV_Module_Path $SloKJV_Github/SloKJV_sword.xml -v KJVA -z
# osis2mod /usr/share/sword/modules/texts/ztext/slokjv/ /home/pc/Dokumenti/GitHub/SloKJV/SloKJV_sword.xml -v KJVA -z



# Patch from
# wget https://parlons-de-dragons.com/slokjv/slokjv.diff --no-check-certificate -O $SloKJVepubPath/slokjv.diff
# patch $SloKJVepubPath/test.py slokjv.diff 

# Making html files...
echo
echo    Kreiram html datoteke...
echo
python3 $SloKJVepubPath/test.py   # |& tee    log.txt

echo
echo    Popravljam html datoteke...
echo
# Paragraphs replaced line before with <p>\&nbsp;<\/p>
#sed -i ':a;N;$!ba;s/\(<span class=\"verseNbr\">[0-9]\+<\/span>\)\n   \n/<p>\&#160;<\/p>\n  \1\n   /g'  $SloKJVepubPath/html/*.html
sed -i ':a;N;$!ba;s/\(<span class=\"verseNbr\">[0-9]\+<\/span>\)\n   \n/<br \/>\n  \1\n   /g'  $SloKJVepubPath/html/*.html

# Hebrejske crke - dodam prelom, da gr besedilo v novo vrstico    [iz]<br>  pa potem nazaj popravim
sed -i 's/]/]<br \/>/g'       $SloKJVepubPath/html/21-Ps-119.html
sed -i 's/iz\]<br \/>/iz\]/g' $SloKJVepubPath/html/21-Ps-119.html

# Pred hebrejskimi crkami nardi <br>
# yet to do


# Popravi kazalo da ni pikice pred -Kazalo in ga spremeni v H2
#  13 <li>
#  14  <a href="01-TOC.html">Kazalo</a>
#  15  </li>
sed -i ':a;N;$!ba;s/<ul>\n<li>\n <a href=\"01-TOC.html\">Kazalo knjig<\/a>\n <\/li>/<H2>Kazalo knjig<\/H2>\n<ul>/g' $SloKJVepubPath/html/01-TOC.html

# Spravi gor <ul> za dve vrstici
#</a>
# 
# <ul>
sed -i ':a;N;$!ba;s/<\/a>\n \n <ul>/<\/a><ul>/g' $SloKJVepubPath/html/01-TOC.html

echo #Spravi gor <li> za eno vrstico in vmes doda presledek
sed -i ':a;N;$!ba;s/<li>\n <a/<li> <a/g' $SloKJVepubPath/html/01-TOC.html

echo Pri vrstici Pregovor odstrani prvi presledek v tej vrstici - da ne pride to dvakrat v kazalo
echo   in baskslah li da eno visje
sed -i ':a;N;$!ba;s/<li> <a href=\"02-Foreword.html\">Predgovor<\/a>\n <\/li>/<li><a href=\"02-Foreword.html\">Kolofon in predgovor<\/a><\/li><br \/>/g' $SloKJVepubPath/html/01-TOC.html

rm $SloKJVepubPath/templates/TOC_temp.txt     >/dev/null 2>&1
echo  Doda dodatno kazalo knjig v zacasno datoteko in uposteva dodan presledek dve vrstici nazaj
cat $SloKJVepubPath/html/01-TOC.html |grep '<li> <a' >$SloKJVepubPath/templates/TOC_temp.txt

echo  Zamenja ul z  baskslash li
sed -i 's/<ul>/<\/li>/g' $SloKJVepubPath/templates/TOC_temp.txt

echo '<h2>Podrobno kazalo</h2>' >> $SloKJVepubPath/templates/TOC_temp.txt

awk -vn=1 '{print}; /Predgovor/ && n{while (getline <"templates/TOC_temp.txt") print;n=0}' html/01-TOC.html >html/01-TOC-popravljen.html 
mv html/01-TOC-popravljen.html html/01-TOC.html

# Pobrise zacasno datoteko
rm templates/TOC_temp.txt

# Obe Kroniske dobita sumnik in kazalo
#sed -i 's/Kroniska/Kroniška/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Kroniska/Kroniška/g' $SloKJVepubPath/html/15-1Chr*.html
#sed -i 's/Kroniska/Kroniška/g' $SloKJVepubPath/html/16-2Chr*.html

# Visoka pesem rata Pesem pesmi
#sed -i 's/Visoka pesem/Pesem pesmi/g' $SloKJVepubPath/html/01-TOC.html

# Zalostinke dobi ZZ
#sed -i 's/Zalostinke/Žalostinke/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Zalostinke/Žalostinke/g' $SloKJVepubPath/html/27-Lam*.html

# Dela postane Apostoslska dela
#sed -i 's/Dela/Apostolska dela/g' $SloKJVepubPath/html/01-TOC.html

# Korincanom dobi sumnik
#sed -i 's/Korincanom/Korinčanom/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Korincanom/Korinčanom/g' $SloKJVepubPath/html/48-1Cor*.html
#sed -i 's/Korincanom/Korinčanom/g' $SloKJVepubPath/html/49-2Cor*.html

# Galacanom dobi sumnik
#sed -i 's/Galacanom/Galačanom/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Galacanom/Galačanom/g' $SloKJVepubPath/html/50-Gal*.html

# Efezanom dobi sumnik
#sed -i 's/Efezanom/Efežanom/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Efezanom/Efežanom/g' $SloKJVepubPath/html/51-Eph*.html

# Kolosanom dobi sumnik
#sed -i 's/Kolosanom/Kološanom/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Kolosanom/Kološanom/g' $SloKJVepubPath/html/53-Col*.html

# Obe knjigi Tesalonicanom dobita sumnik in Kazalo
#sed -i 's/Tesalonicanom/Tesaloničanom/g' $SloKJVepubPath/html/01-TOC.html
#sed -i 's/Tesalonicanom/Tesaloničanom/g' $SloKJVepubPath/html/54-1Thess*.html
#sed -i 's/Tesalonicanom/Tesaloničanom/g' $SloKJVepubPath/html/55-2Thess*.html


# V podrobnem kazalu odstrani naslove poglavij knjig da ostanejo samo stevilke poglavij
sed -i 's/^ <a href=\"\([-a-zA-Z0-9]*\).html\">\([A-Za-zčžšČŽŠ., ]*\) \([0-9]*\)<\/a>/<a href=\"\1.html\">\3<\/a>/g'    $SloKJVepubPath/html/01-TOC.html
sed -i 's/Salomonova pesem \[hebr. Pesem pesmi\] \([0-9]\)<\/a>,/\1<\/a>,/g'                                            $SloKJVepubPath/html/01-TOC.html

echo
echo Pozene Urejevalnik besedil in v njem pripravi toc.ncx
echo
gnome-terminal -- sh -c 'gedit /home/pc/Dokumenti/epub/toc.ncx'

echo
echo Pozene Sigil 2.0...     zakomentiran
echo
echo   Nadaljuj z  Text, desni klik, add existing files
echo   iz mape $SloKJVepubPath/html
echo   
echo   Potem imas v imenih datotek na vrhu navodila
echo
echo   Ko to koncas to objavi na https://kdp.amazon.com/
echo
/usr/bin/flatpak run --branch=stable --arch=x86_64 --command=sigil --file-forwarding com.sigil_ebook.Sigil >/dev/null 2>&1
		# sigil >/dev/null 2>&1    # Ta pozene verzijo 3.0

mv $SloKJVepubPath/untitled.epub $SloKJV_Github/SloKJV.epub


cd $SloKJV_Github

git add SloKJV.epub
git commit -m "SloKJV - epub (Kindle, Kobo,...)"

echo  pozene github # zakomentirano
github

cd $SloKJVepubPath

# Preveri ali je prav naredil
# pico html/15-1Chr-19.html

echo Odpre brskalnik kjer se knjigo nalozi na Amazon.com
xdg-open https://kdp.amazon.com/
